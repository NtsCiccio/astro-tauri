---
import MicroAppLayout from "../../layouts/MicroAppLayout.astro";

const textareaBase =
	"w-full text-sm sm:text-base text-gray-50 bg-gray-900 border border-gray-800 rounded-lg p-3 sm:p-4 focus:outline-none resize-none placeholder:text-gray-600 font-mono";
const textareaFocus = "focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500";

const buttonBase =
	"flex-1 px-6 py-3 text-sm sm:text-base font-semibold text-white rounded-lg transition-colors duration-200 shadow-lg";
---

<MicroAppLayout pageTitle="JSON Formatter" title="JSON Formatter & Validator">
	<div class="flex flex-col gap-6">
		<div class="flex flex-col gap-2">
			<label for="input" class="text-sm font-medium text-gray-400 sm:text-base"> Input JSON </label>
			<textarea
				id="input"
				rows="10"
				class={`${textareaBase} ${textareaFocus}`}
				placeholder='Inserisci il JSON da formattare o validare...&#10;Esempio: {"name":"test","value":123}'></textarea>
		</div>

		<div id="errorMessage" class="hidden rounded-lg bg-red-900/30 border border-red-800 p-3 text-sm text-red-300"></div>

		<div class="flex flex-col gap-2">
			<div class="flex items-center justify-between">
				<label for="output" class="text-sm font-medium text-gray-400 sm:text-base"> Output </label>
				<div class="flex items-center gap-2 text-xs text-gray-500">
					<span id="charCount">0 caratteri</span>
				</div>
			</div>
			<textarea
				id="output"
				rows="10"
				readonly
				class={textareaBase}
				placeholder="Il JSON formattato apparirà qui..."></textarea>
		</div>

		<div class="flex flex-col gap-3 sm:flex-row">
			<button
				id="formatButton"
				class={`${buttonBase} bg-green-600 hover:bg-green-700 active:bg-green-800 shadow-green-500/20`}
			>
				Format
			</button>
			<button
				id="minifyButton"
				class={`${buttonBase} bg-blue-600 hover:bg-blue-700 active:bg-blue-800 shadow-blue-500/20`}
			>
				Minify
			</button>
			<button
				id="validateButton"
				class={`${buttonBase} bg-purple-600 hover:bg-purple-700 active:bg-purple-800 shadow-purple-500/20`}
			>
				Validate
			</button>
			<button
				id="resetButton"
				class={`${buttonBase} bg-gray-700 hover:bg-gray-600 active:bg-gray-500 shadow-gray-500/20`}
			>
				Reset
			</button>
		</div>
	</div>
</MicroAppLayout>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const formatButton = document.getElementById("formatButton");
		const minifyButton = document.getElementById("minifyButton");
		const validateButton = document.getElementById("validateButton");
		const resetButton = document.getElementById("resetButton");

		const inputEl = document.getElementById("input") as HTMLTextAreaElement | null;
		const outputEl = document.getElementById("output") as HTMLTextAreaElement | null;
		const errorMessageEl = document.getElementById("errorMessage");
		const charCountEl = document.getElementById("charCount");

		function hideError() {
			if (errorMessageEl) {
				errorMessageEl.classList.add("hidden");
				errorMessageEl.textContent = "";
			}
		}

		function showError(message: string) {
			if (errorMessageEl) {
				errorMessageEl.classList.remove("hidden");
				errorMessageEl.textContent = message;
			}
		}

		function updateCharCount(text: string) {
			if (charCountEl) {
				charCountEl.textContent = `${text.length} caratteri`;
			}
		}

		function formatJSON(jsonString: string, indent: number = 2): string | null {
			try {
				const parsed = JSON.parse(jsonString);
				return JSON.stringify(parsed, null, indent);
			} catch (error) {
				return null;
			}
		}

		function minifyJSON(jsonString: string): string | null {
			try {
				const parsed = JSON.parse(jsonString);
				return JSON.stringify(parsed);
			} catch (error) {
				return null;
			}
		}

		function validateJSON(jsonString: string): { valid: boolean; error?: string } {
			if (!jsonString.trim()) {
				return { valid: false, error: "Il campo input è vuoto" };
			}

			try {
				JSON.parse(jsonString);
				return { valid: true };
			} catch (error) {
				if (error instanceof Error) {
					return { valid: false, error: error.message };
				}
				return { valid: false, error: "Errore sconosciuto durante la validazione" };
			}
		}

		formatButton?.addEventListener("click", () => {
			if (!inputEl || !outputEl) return;

			hideError();
			const input = inputEl.value.trim();

			if (!input) {
				showError("Inserisci del JSON da formattare");
				return;
			}

			const formatted = formatJSON(input, 2);
			if (formatted) {
				outputEl.value = formatted;
				updateCharCount(formatted);
			} else {
				showError("JSON non valido. Controlla la sintassi.");
				outputEl.value = "";
				updateCharCount("");
			}
		});

		minifyButton?.addEventListener("click", () => {
			if (!inputEl || !outputEl) return;

			hideError();
			const input = inputEl.value.trim();

			if (!input) {
				showError("Inserisci del JSON da minificare");
				return;
			}

			const minified = minifyJSON(input);
			if (minified) {
				outputEl.value = minified;
				updateCharCount(minified);
			} else {
				showError("JSON non valido. Controlla la sintassi.");
				outputEl.value = "";
				updateCharCount("");
			}
		});

		validateButton?.addEventListener("click", () => {
			if (!inputEl || !outputEl) return;

			hideError();
			const input = inputEl.value.trim();

			const result = validateJSON(input);
			if (result.valid) {
				// Se valido, formatta anche l'output
				const formatted = formatJSON(input, 2);
				if (formatted) {
					outputEl.value = formatted;
					updateCharCount(formatted);
				}
				showError("✓ JSON valido!");
				errorMessageEl?.classList.remove("bg-red-900/30", "border-red-800", "text-red-300");
				errorMessageEl?.classList.add("bg-green-900/30", "border-green-800", "text-green-300");
			} else {
				showError(`✗ JSON non valido: ${result.error || "Errore sconosciuto"}`);
				errorMessageEl?.classList.remove("bg-green-900/30", "border-green-800", "text-green-300");
				errorMessageEl?.classList.add("bg-red-900/30", "border-red-800", "text-red-300");
				outputEl.value = "";
				updateCharCount("");
			}
		});

		resetButton?.addEventListener("click", () => {
			if (!inputEl || !outputEl) return;

			inputEl.value = "";
			outputEl.value = "";
			hideError();
			updateCharCount("");
		});

		// Aggiorna il conteggio caratteri quando cambia l'output
		if (outputEl) {
			outputEl.addEventListener("input", () => {
				updateCharCount(outputEl.value);
			});
		}
	});
</script>

